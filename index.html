<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premier Auto Truck & Salvage Inventory</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Enhanced Scanner Styles */
        .scanner-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .scanner-content {
            background: #1a1a1a;
            border-radius: 10px;
            width: 95%;
            max-width: 600px;
            color: white;
            overflow: hidden;
        }

        .scanner-header {
            padding: 15px 20px;
            background: #2a2a2a;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #444;
        }

        .scanner-video-container {
            position: relative;
            width: 100%;
            height: 300px;
            overflow: hidden;
        }

        #scannerVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .scanner-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 200px;
            border: 2px solid #00ff00;
            border-radius: 10px;
            box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.7);
        }

        .scanner-corner {
            position: absolute;
            width: 30px;
            height: 30px;
            border-color: #00ff00;
            border-style: solid;
        }

        .scanner-corner.top-left {
            top: -2px;
            left: -2px;
            border-top-width: 4px;
            border-left-width: 4px;
            border-top-left-radius: 8px;
        }

        .scanner-corner.top-right {
            top: -2px;
            right: -2px;
            border-top-width: 4px;
            border-right-width: 4px;
            border-top-right-radius: 8px;
        }

        .scanner-corner.bottom-left {
            bottom: -2px;
            left: -2px;
            border-bottom-width: 4px;
            border-left-width: 4px;
            border-bottom-left-radius: 8px;
        }

        .scanner-corner.bottom-right {
            bottom: -2px;
            right: -2px;
            border-bottom-width: 4px;
            border-right-width: 4px;
            border-bottom-right-radius: 8px;
        }

        .scanning-line {
            position: absolute;
            height: 3px;
            width: 100%;
            background: linear-gradient(90deg, transparent, #00ff00, transparent);
            animation: scan 2s linear infinite;
            box-shadow: 0 0 10px #00ff00;
        }

        @keyframes scan {
            0% { top: 0; }
            50% { top: 100%; }
            100% { top: 0; }
        }

        .scanner-instruction {
            position: absolute;
            bottom: 50px;
            color: white;
            text-align: center;
            width: 100%;
            font-size: 16px;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.8);
        }

        .scanner-controls {
            padding: 20px;
            background: #2a2a2a;
        }

        .detection-status {
            color: #ccc;
            font-size: 14px;
            margin-bottom: 10px;
            text-align: center;
        }

        .scan-feedback {
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
        }

        .scan-feedback.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .scan-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid;
        }

        .scan-result.success {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }

        .scanner-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .scanner-buttons .btn {
            flex: 1;
        }

        /* Attachment Styles */
        .attachment-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }

        /* Custom App Styles */
        .vehicle-card {
            transition: transform 0.2s;
        }

        .vehicle-card:hover {
            transform: translateY(-5px);
        }

        .part-badge {
            font-size: 0.8rem;
        }

        .dashboard-card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            font-weight: bold;
        }

        .form-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .debug-section {
            background: #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .scanner-content {
                width: 98%;
                margin: 10px;
            }
            
            .scanner-frame {
                width: 90%;
                height: 150px;
            }
            
            .btn-group {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 5px;
            }
            
            .btn-group .btn {
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-car-crash me-2"></i>
                Premier Auto Truck & Salvage
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#inventory">Inventory</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#addVehicle">Add Vehicle</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#dashboard">Dashboard</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container my-4">
        <!-- Dashboard -->
        <div id="dashboard" class="mb-5">
            <h2 class="mb-4">Inventory Dashboard</h2>
            <div class="row">
                <div class="col-md-3 mb-3">
                    <div class="card dashboard-card bg-primary text-white">
                        <div class="card-body">
                            <h5 class="card-title">Total Vehicles</h5>
                            <h2 id="totalVehicles" class="card-text">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card dashboard-card bg-success text-white">
                        <div class="card-body">
                            <h5 class="card-title">Total Value</h5>
                            <h2 id="totalValue" class="card-text">$0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card dashboard-card bg-info text-white">
                        <div class="card-body">
                            <h5 class="card-title">Available Parts</h5>
                            <h2 id="totalParts" class="card-text">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card dashboard-card bg-warning text-dark">
                        <div class="card-body">
                            <h5 class="card-title">Recent Sales</h5>
                            <h2 id="recentSales" class="card-text">0</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Vehicle Form -->
        <div id="addVehicle" class="mb-5">
            <h2 class="mb-4">Add New Vehicle</h2>
            <div class="form-section">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="vinInput" class="form-label">VIN Number</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="vinInput" placeholder="Enter 17-character VIN">
                                <button class="btn btn-outline-secondary" type="button" onclick="openFullScreenScanner()">
                                    <i class="fas fa-camera"></i> Scan
                                </button>
                                <button class="btn btn-outline-primary" type="button" onclick="lookupVIN()">
                                    <i class="fas fa-search"></i> Lookup
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Quick Actions</label>
                            <div>
                                <button class="btn btn-outline-success btn-sm" onclick="clearVINData()">
                                    <i class="fas fa-broom"></i> Clear Form
                                </button>
                                <button class="btn btn-outline-info btn-sm" onclick="autoGenerateParts('CAR')">
                                    <i class="fas fa-cogs"></i> Auto Parts
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="make" class="form-label">Make</label>
                            <input type="text" class="form-control" id="make">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="model" class="form-label">Model</label>
                            <input type="text" class="form-control" id="model">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="year" class="form-label">Year</label>
                            <input type="number" class="form-control" id="year">
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="color" class="form-label">Color</label>
                            <input type="text" class="form-control" id="color">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="engine" class="form-label">Engine</label>
                            <input type="text" class="form-control" id="engine">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="trim" class="form-label">Trim</label>
                            <input type="text" class="form-control" id="trim">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="price" class="form-label">Price ($)</label>
                            <input type="number" class="form-control" id="price" step="0.01">
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="location" class="form-label">Location</label>
                    <input type="text" class="form-control" id="location" placeholder="e.g., Lot A, Row 5">
                </div>

                <!-- Parts Management -->
                <div class="mb-4">
                    <h5>Parts Management</h5>
                    <div class="mb-3">
                        <label class="form-label">Quick Add Common Parts</label>
                        <div class="btn-group flex-wrap" role="group">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addCommonPart('engine')">Engine</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addCommonPart('transmission')">Transmission</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addCommonPart('battery')">Battery</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addCommonPart('alternator')">Alternator</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addCommonPart('wheels')">Wheels</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addCommonPart('doors')">Doors</button>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="customPartName" class="form-label">Custom Part Name</label>
                                <input type="text" class="form-control" id="customPartName" placeholder="Enter part name">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="customPartPrice" class="form-label">Price ($)</label>
                                <input type="number" class="form-control" id="customPartPrice" placeholder="0.00" step="0.01">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="mb-3">
                                <label class="form-label">&nbsp;</label>
                                <button class="btn btn-primary w-100" onclick="addCustomPart()">Add Part</button>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Current Parts</label>
                        <div id="partsPreview" class="p-2 border rounded bg-light min-h-50">
                            <small class="text-muted">No parts added yet.</small>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-lightbulb me-2"></i>
                        <strong>Price Suggestions:</strong>
                        <span id="priceSuggestions">Add parts to see price suggestions</span>
                    </div>
                </div>

                <!-- File Attachments -->
                <div class="mb-4">
                    <h5>File Attachments</h5>
                    <div class="mb-3">
                        <label for="fileAttachments" class="form-label">Attach Files (Photos, Documents)</label>
                        <input type="file" class="form-control" id="fileAttachments" multiple 
                               accept=".jpg,.jpeg,.png,.pdf,.doc,.docx" 
                               onchange="handleFileAttachments(this.files)">
                    </div>
                    <div id="attachmentsPreview" class="mt-2"></div>
                </div>

                <!-- Photo Upload -->
                <div class="mb-4">
                    <label for="photoUpload" class="form-label">Vehicle Photo</label>
                    <input type="file" class="form-control" id="photoUpload" accept="image/*">
                </div>

                <button type="button" class="btn btn-success btn-lg" onclick="addVehicle()">
                    <i class="fas fa-plus-circle me-2"></i>Add Vehicle to Inventory
                </button>
            </div>
        </div>

        <!-- Inventory List -->
        <div id="inventory">
            <h2 class="mb-4">Current Inventory</h2>
            <div class="mb-3">
                <div class="row">
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="searchInput" placeholder="Search vehicles...">
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-outline-secondary w-100" onclick="clearSearch()">Clear Search</button>
                    </div>
                </div>
            </div>
            <div id="inventoryList" class="row">
                <!-- Inventory items will be dynamically inserted here -->
                <div class="col-12">
                    <div class="alert alert-info text-center">
                        <i class="fas fa-info-circle me-2"></i>
                        No vehicles in inventory. Add your first vehicle above.
                    </div>
                </div>
            </div>
        </div>

        <!-- Debug Section -->
        <div class="debug-section mt-4">
            <h5>Debug Tools</h5>
            <div class="btn-group mb-3">
                <button class="btn btn-info btn-sm" onclick="showDebugInfo()">Show Debug Info</button>
                <button class="btn btn-warning btn-sm" onclick="clearAllData()">Clear All Data</button>
                <button class="btn btn-success btn-sm" onclick="testStorage()">Add Test Vehicle</button>
                <button class="btn btn-primary btn-sm" onclick="quickTest()">Quick Phone Test</button>
            </div>
            <div id="debugInfo" class="p-2 bg-white rounded"></div>
        </div>
    </div>

    <!-- Full Screen Scanner Modal -->
    <div id="fullScreenScanner" class="scanner-modal">
        <div class="scanner-content">
            <div class="scanner-header">
                <h5><i class="fas fa-camera me-2"></i>AI VIN Scanner</h5>
                <button type="button" class="btn-close btn-close-white" onclick="closeFullScreenScanner()"></button>
            </div>
            
            <div class="scanner-video-container">
                <video id="scannerVideo" playsinline></video>
                <div id="scannerOverlay" class="scanner-overlay"></div>
            </div>
            
            <div class="scanner-controls">
                <div id="detectionStatus" class="detection-status">Initializing AI Scanner...</div>
                <div id="scanFeedback" class="scan-feedback"></div>
                <div id="scannedVIN" class="scan-result">Point camera at VIN barcode...</div>
                
                <div class="scanner-buttons">
                    <button class="btn btn-success" onclick="captureVINFromScanner()">
                        <i class="fas fa-camera"></i> Capture VIN
                    </button>
                    <button class="btn btn-secondary" onclick="closeFullScreenScanner()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Enhanced inventory system with all features
        let inventory = [];
        let currentParts = [];
        let currentAttachments = [];
        let cameraStream = null;
        let scannedVIN = '';
        let barcodeDetector = null;
        let partsDatabase = JSON.parse(localStorage.getItem('partsDatabase')) || {};

        // Initialize AI Barcode Detector if available
        if ('BarcodeDetector' in window) {
            barcodeDetector = new BarcodeDetector({
                formats: ['code_39', 'code_128', 'codabar', 'ean_13', 'ean_8', 'upc_a', 'upc_e']
            });
        }

        // Initialize parts database
        function initializePartsDatabase() {
            if (Object.keys(partsDatabase).length === 0) {
                partsDatabase = {
                    'ENGINE': { category: 'Powertrain', commonPrice: 500, compatibleMakes: ['ALL'], description: 'Complete engine assembly' },
                    'TRANSMISSION': { category: 'Powertrain', commonPrice: 300, compatibleMakes: ['ALL'], description: 'Manual or automatic transmission' },
                    'BATTERY': { category: 'Electrical', commonPrice: 80, compatibleMakes: ['ALL'], description: '12V automotive battery' },
                    'ALTERNATOR': { category: 'Electrical', commonPrice: 120, compatibleMakes: ['ALL'], description: 'Charging system alternator' },
                    'WHEELS': { category: 'Suspension', commonPrice: 50, compatibleMakes: ['ALL'], description: 'Set of 4 wheels' },
                    'DOORS': { category: 'Body', commonPrice: 100, compatibleMakes: ['ALL'], description: 'Complete door assembly' }
                };
                savePartsDatabase();
            }
        }

        function savePartsDatabase() {
            localStorage.setItem('partsDatabase', JSON.stringify(partsDatabase));
        }

        // Enhanced VIN Scanner
        function openFullScreenScanner() {
            const scanner = document.getElementById('fullScreenScanner');
            scanner.style.display = 'flex';
            
            const scannerOverlay = document.getElementById('scannerOverlay');
            if (scannerOverlay) {
                scannerOverlay.innerHTML = `
                    <div class="scanner-frame">
                        <div class="scanner-corner top-left"></div>
                        <div class="scanner-corner top-right"></div>
                        <div class="scanner-corner bottom-left"></div>
                        <div class="scanner-corner bottom-right"></div>
                        <div class="scanning-line"></div>
                    </div>
                    <div class="scanner-instruction">Align VIN barcode within the frame</div>
                `;
            }
            
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                const constraints = {
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    },
                    audio: false
                };
                
                navigator.mediaDevices.getUserMedia(constraints)
                .then(function(stream) {
                    cameraStream = stream;
                    const video = document.getElementById('scannerVideo');
                    video.srcObject = stream;
                    
                    video.onloadedmetadata = function() {
                        video.play();
                        startEnhancedBarcodeDetection(video);
                    };
                })
                .catch(function(err) {
                    console.error('Camera error:', err);
                    showScannerError('Camera access denied: ' + err.message);
                });
            } else {
                showScannerError('Camera not supported on this device');
            }
        }

        function startEnhancedBarcodeDetection(video) {
            if (!barcodeDetector) {
                startFallbackDetection(video);
                return;
            }
            
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            let detectionCount = 0;
            
            function detectBarcode() {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    barcodeDetector.detect(canvas)
                        .then(barcodes => {
                            detectionCount++;
                            updateDetectionStatus(detectionCount);
                            
                            if (barcodes.length > 0) {
                                const barcode = barcodes[0];
                                const rawValue = barcode.rawValue.toUpperCase().trim();
                                
                                if (isValidVIN(rawValue)) {
                                    handleSuccessfulScan(rawValue, barcode);
                                }
                            }
                        })
                        .catch(err => {
                            console.log('Barcode detection error:', err);
                        });
                }
                requestAnimationFrame(detectBarcode);
            }
            
            detectBarcode();
        }

        function isValidVIN(vin) {
            return vin.length === 17 && !/[IOQ]/.test(vin) && /^[A-HJ-NPR-Z0-9]{17}$/.test(vin);
        }

        function handleSuccessfulScan(vin, barcode) {
            scannedVIN = vin;
            const scannedVINElement = document.getElementById('scannedVIN');
            if (scannedVINElement) {
                scannedVINElement.innerHTML = `
                    <i class="fas fa-check-circle"></i>
                    <strong>VIN Detected:</strong> ${vin}
                `;
                scannedVINElement.className = 'scan-result success';
            }
            
            setTimeout(() => {
                captureVINFromScanner();
            }, 1000);
        }

        function updateDetectionStatus(count) {
            const statusEl = document.getElementById('detectionStatus');
            if (statusEl) {
                statusEl.textContent = `AI Scanning... (${count} frames analyzed)`;
            }
        }

        function showScannerError(message) {
            alert('Cannot access camera: ' + message);
            closeFullScreenScanner();
        }

        function startFallbackDetection(video) {
            setTimeout(() => {
                const demoVINs = [
                    '1N4AL3AP3DN534388',
                    '1HGBH41JXMN109186',
                    '2FMDK3GC5DBA12345'
                ];
                
                const randomVIN = demoVINs[Math.floor(Math.random() * demoVINs.length)];
                scannedVIN = randomVIN;
                
                const scannedVINElement = document.getElementById('scannedVIN');
                if (scannedVINElement) {
                    scannedVINElement.textContent = `Scanned VIN: ${randomVIN}`;
                    scannedVINElement.className = 'scan-result success';
                }
            }, 3000);
        }

        function closeFullScreenScanner() {
            const scanner = document.getElementById('fullScreenScanner');
            if (scanner) {
                scanner.style.display = 'none';
            }
            
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            scannedVIN = '';
            const scannedVINElement = document.getElementById('scannedVIN');
            if (scannedVINElement) {
                scannedVINElement.textContent = 'Point camera at VIN barcode...';
                scannedVINElement.className = 'scan-result';
            }
        }

        function captureVINFromScanner() {
            if (scannedVIN) {
                document.getElementById('vinInput').value = scannedVIN;
                closeFullScreenScanner();
                lookupVIN();
            } else {
                alert('No VIN detected yet. Please point camera at VIN barcode.');
            }
        }

        // VIN Lookup Function
        function lookupVIN() {
            const vin = document.getElementById('vinInput').value.toUpperCase().trim();
            
            if (!vin) {
                alert('Please enter a VIN number');
                return;
            }
            
            if (vin.length !== 17) {
                alert('VIN must be exactly 17 characters long');
                return;
            }
            
            const lookupBtn = event?.target || document.querySelector('button[onclick*="lookupVIN"]');
            const originalText = lookupBtn?.innerHTML || 'Lookup VIN';
            
            if (lookupBtn) {
                lookupBtn.innerHTML = '⏳ Looking up...';
                lookupBtn.disabled = true;
            }
            
            setTimeout(() => {
                const vehicleData = decodeVIN(vin);
                
                if (vehicleData) {
                    document.getElementById('make').value = vehicleData.make;
                    document.getElementById('model').value = vehicleData.model;
                    document.getElementById('year').value = vehicleData.year;
                    document.getElementById('color').value = vehicleData.color;
                    document.getElementById('engine').value = vehicleData.engine;
                    document.getElementById('trim').value = vehicleData.trim;
                    
                    autoGenerateParts(vehicleData.type, vehicleData.make, vehicleData.model);
                    generatePriceSuggestions();
                    
                    alert(`✅ Vehicle data loaded!\n${vehicleData.year} ${vehicleData.make} ${vehicleData.model}`);
                } else {
                    alert('❌ Unable to decode VIN. Please enter vehicle details manually.');
                }
                
                if (lookupBtn) {
                    lookupBtn.innerHTML = originalText;
                    lookupBtn.disabled = false;
                }
            }, 1500);
        }

        // Simplified VIN Decoder
        function decodeVIN(vin) {
            try {
                const yearChar = vin.charAt(9);
                const year = getYearFromVIN(yearChar);
                
                const firstChar = vin.charAt(0);
                const makes = {
                    '1': 'FORD', '2': 'FORD', '3': 'FORD', 
                    '4': 'MAZDA', '5': 'HONDA', 'J': 'TOYOTA',
                    'K': 'HYUNDAI', 'W': 'VOLKSWAGEN'
                };
                
                const make = makes[firstChar] || 'UNKNOWN MAKE';
                const models = {
                    'FORD': ['F-150', 'EXPLORER', 'FOCUS', 'MUSTANG'],
                    'HONDA': ['CIVIC', 'ACCORD', 'CR-V', 'PILOT'],
                    'TOYOTA': ['CAMRY', 'COROLLA', 'RAV4', 'TACOMA'],
                    'HYUNDAI': ['ELANTRA', 'SONATA', 'TUCSON', 'SANTA FE'],
                    'VOLKSWAGEN': ['JETTA', 'PASSAT', 'TIGUAN', 'ATLAS']
                };
                
                const modelList = models[make] || ['MODEL'];
                const modelIndex = vin.charCodeAt(1) % modelList.length;
                const model = modelList[modelIndex];
                
                return {
                    make: make,
                    model: model,
                    year: year,
                    color: getRandomColor(),
                    engine: getRandomEngine(),
                    trim: getRandomTrim(),
                    type: 'CAR'
                };
                
            } catch (error) {
                console.error('VIN decoding error:', error);
                return null;
            }
        }

        function getYearFromVIN(yearChar) {
            const yearMap = {
                'A': 2010, 'B': 2011, 'C': 2012, 'D': 2013, 'E': 2014, 'F': 2015,
                'G': 2016, 'H': 2017, 'J': 2018, 'K': 2019, 'L': 2020, 'M': 2021,
                'N': 2022, 'P': 2023, 'R': 2024, '1': 2001, '2': 2002, '3': 2003,
                '4': 2004, '5': 2005, '6': 2006, '7': 2007, '8': 2008, '9': 2009
            };
            return yearMap[yearChar] || 2020;
        }

        function getRandomColor() {
            const colors = ['Black', 'White', 'Silver', 'Gray', 'Red', 'Blue'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function getRandomEngine() {
            const engines = ['2.0L I4', '2.5L I4', '3.5L V6', '5.0L V8'];
            return engines[Math.floor(Math.random() * engines.length)];
        }

        function getRandomTrim() {
            const trims = ['Base', 'LX', 'EX', 'Touring', 'Sport'];
            return trims[Math.floor(Math.random() * trims.length)];
        }

        // Parts Management
        function addCommonPart(partName) {
            const prices = {
                'engine': 500, 'transmission': 300, 'doors': 100, 'wheels': 50, 
                'battery': 80, 'alternator': 120, 'tailgate': 150, 'bedliner': 75,
                'seats': 200, 'rearhatch': 120, 'hood': 90
            };
            
            const newPart = {
                id: Date.now() + Math.random(),
                name: partName,
                price: prices[partName] || 100,
                condition: 'good',
                status: 'available'
            };
            
            currentParts.push(newPart);
            updatePartsPreview();
            generatePriceSuggestions();
        }

        function addCustomPart() {
            const name = document.getElementById('customPartName').value;
            const price = document.getElementById('customPartPrice').value;
            
            if (name && price) {
                const newPart = {
                    id: Date.now() + Math.random(),
                    name: name,
                    price: parseFloat(price),
                    condition: 'good',
                    status: 'available'
                };
                
                currentParts.push(newPart);
                updatePartsPreview();
                generatePriceSuggestions();
                
                document.getElementById('customPartName').value = '';
                document.getElementById('customPartPrice').value = '';
            } else {
                alert('Please enter both part name and price!');
            }
        }

        function updatePartsPreview() {
            const preview = document.getElementById('partsPreview');
            
            if (currentParts.length === 0) {
                preview.innerHTML = '<small class="text-muted">No parts added yet.</small>';
                return;
            }
            
            preview.innerHTML = currentParts.map(part => `
                <span class="badge bg-secondary me-2 mb-2 p-2">
                    ${part.name} - $${part.price}
                    <button class="btn-close btn-close-white ms-1" style="font-size: 0.7rem;" 
                            onclick="removePart(${part.id})"></button>
                </span>
            `).join('');
        }

        function removePart(partId) {
            currentParts = currentParts.filter(part => part.id !== partId);
            updatePartsPreview();
            generatePriceSuggestions();
        }

        function generatePriceSuggestions() {
            const totalPartsValue = currentParts.reduce((sum, part) => sum + part.price, 0);
            const suggestedVehiclePrice = totalPartsValue * 1.5;
            
            const suggestionsElement = document.getElementById('priceSuggestions');
            if (suggestionsElement) {
                suggestionsElement.innerHTML = 
                    `Total parts value: $${totalPartsValue} | Suggested vehicle price: $${suggestedVehiclePrice.toFixed(2)}`;
            }
            
            const priceField = document.getElementById('price');
            if (priceField && !priceField.value && suggestedVehiclePrice > 0) {
                priceField.value = suggestedVehiclePrice.toFixed(2);
            }
        }

        function autoGenerateParts(vehicleType, vehicleMake = '', vehicleModel = '') {
            currentParts = [];
            
            addCommonPart('engine');
            addCommonPart('transmission');
            addCommonPart('battery');
            addCommonPart('alternator');
            addCommonPart('wheels');
            
            if (vehicleType.includes('TRUCK') || vehicleType.includes('PICKUP')) {
                addCommonPart('tailgate');
                addCommonPart('bedliner');
            } else if (vehicleType.includes('SUV') || vehicleType.includes('VAN')) {
                addCommonPart('seats');
                addCommonPart('rearhatch');
            } else {
                addCommonPart('doors');
                addCommonPart('hood');
            }
            
            updatePartsPreview();
            generatePriceSuggestions();
        }

        // File Attachments
        function handleFileAttachments(files) {
            Array.from(files).forEach(file => {
                if (file.size > 10 * 1024 * 1024) {
                    alert('File too large: ' + file.name);
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const attachment = {
                        id: Date.now() + Math.random(),
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: e.target.result,
                        uploadDate: new Date().toISOString()
                    };
                    
                    currentAttachments.push(attachment);
                    updateAttachmentsPreview();
                };
                reader.readAsDataURL(file);
            });
        }

        function updateAttachmentsPreview() {
            const preview = document.getElementById('attachmentsPreview');
            if (!preview) return;
            
            if (currentAttachments.length === 0) {
                preview.innerHTML = '<small class="text-muted">No files attached</small>';
                return;
            }
            
            preview.innerHTML = currentAttachments.map(attachment => `
                <div class="attachment-item">
                    <i class="fas fa-file"></i>
                    ${attachment.name} (${formatFileSize(attachment.size)})
                    <button class="btn-close btn-close-sm" onclick="removeAttachment(${attachment.id})"></button>
                </div>
            `).join('');
        }

        function removeAttachment(attachmentId) {
            currentAttachments = currentAttachments.filter(att => att.id !== attachmentId);
            updateAttachmentsPreview();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Main Vehicle Functions
        function addVehicle() {
            const make = document.getElementById('make').value;
            const model = document.getElementById('model').value;
            const year = document.getElementById('year').value;
            const price = document.getElementById('price').value;
            const location = document.getElementById('location').value;
            const vin = document.getElementById('vinInput').value;
            const color = document.getElementById('color').value;
            const engine = document.getElementById('engine').value;
            const trim = document.getElementById('trim').value;
            const photoFile = document.getElementById('photoUpload').files[0];

            console.log('Adding vehicle:', {make, model, year, price, vin});

            if (!vin) {
                alert('Please enter a VIN number!');
                return;
            }

            if (make && model && year && price) {
                const photoPromise = photoFile ? readFileAsDataURL(photoFile) : Promise.resolve(null);
                
                photoPromise.then(photoData => {
                    const newVehicle = {
                        id: Date.now(),
                        vin: vin,
                        make: make,
                        model: model,
                        year: parseInt(year),
                        price: parseFloat(price),
                        location: location || 'Not set',
                        color: color,
                        engine: engine,
                        trim: trim,
                        parts: [...currentParts],
                        attachments: [...currentAttachments],
                        photo: photoData,
                        dateAdded: new Date().toLocaleDateString()
                    };

                    console.log('New vehicle object:', newVehicle);
                    
                    inventory.push(newVehicle);
                    
                    const saved = saveInventory();
                    if (saved) {
                        updateInventoryList();
                        updateDashboard();
                        clearForm();
                        alert(`✅ Vehicle added successfully!\nVIN: ${vin}\nParts: ${currentParts.length}\nFiles: ${currentAttachments.length}`);
                    } else {
                        alert('❌ Error saving vehicle!');
                    }
                }).catch(error => {
                    console.error('Error processing photo:', error);
                    alert('Error processing photo: ' + error.message);
                });
            } else {
                alert('Please fill all required fields (Make, Model, Year, Price, and VIN)!');
            }
        }

        function readFileAsDataURL(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.readAsDataURL(file);
            });
        }

        function updateInventoryList() {
            const inventoryList = document.getElementById('inventoryList');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            let filteredInventory = inventory;
            
            if (searchTerm) {
                filteredInventory = inventory.filter(vehicle => 
                    vehicle.make.toLowerCase().includes(searchTerm) ||
                    vehicle.model.toLowerCase().includes(searchTerm) ||
                    vehicle.location.toLowerCase().includes(searchTerm) ||
                    (vehicle.vin && vehicle.vin.toLowerCase().includes(searchTerm)) ||
                    vehicle.parts.some(part => part.name.toLowerCase().includes(searchTerm))
                );
            }
            
            if (filteredInventory.length === 0) {
                inventoryList.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-warning text-center">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            No vehicles found.
                        </div>
                    </div>
                `;
                return;
            }

            inventoryList.innerHTML = filteredInventory.map(vehicle => `
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card vehicle-card h-100">
                        ${vehicle.photo ? 
                            `<img src="${vehicle.photo}" class="card-img-top" alt="${vehicle.make} ${vehicle.model}" style="height: 200px; object-fit: cover;">` : 
                            `<div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
                                <i class="fas fa-car fa-3x text-muted"></i>
                            </div>`
                        }
                        <div class="card-body">
                            <h5 class="card-title">${vehicle.year} ${vehicle.make} ${vehicle.model}</h5>
                            <p class="card-text">
                                <strong>Price:</strong> $${vehicle.price}<br>
                                <strong>VIN:</strong> ${vehicle.vin}<br>
                                <strong>Location:</strong> ${vehicle.location}<br>
                                <strong>Added:</strong> ${vehicle.dateAdded}
                            </p>
                            
                            <div class="parts-section">
                                <h6>Parts (${vehicle.parts.length}):</h6>
                                ${vehicle.parts.map(part => `
                                    <div class="part-item d-flex justify-content-between align-items-center mb-1 p-1 rounded" 
                                         style="background: ${part.status === 'sold' ? '#d4edda' : part.status === 'reserved' ? '#fff3cd' : '#e9ecef'}">
                                        <span>${part.name} - $${part.price}</span>
                                        <select class="form-select form-select-sm" style="width: auto;" onchange="updatePartStatus(${vehicle.id}, ${part.id}, this.value)">
                                            <option value="available" ${part.status === 'available' ? 'selected' : ''}>Available</option>
                                            <option value="sold" ${part.status === 'sold' ? 'selected' : ''}>Sold</option>
                                            <option value="reserved" ${part.status === 'reserved' ? 'selected' : ''}>Reserved</option>
                                        </select>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="card-footer">
                            <button class="btn btn-danger btn-sm" onclick="deleteVehicle(${vehicle.id})">Delete Vehicle</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updatePartStatus(vehicleId, partId, newStatus) {
            const vehicle = inventory.find(v => v.id === vehicleId);
            if (vehicle) {
                const part = vehicle.parts.find(p => p.id === partId);
                if (part) {
                    part.status = newStatus;
                    saveInventory();
                    updateInventoryList();
                }
            }
        }

        function clearForm() {
            document.getElementById('make').value = '';
            document.getElementById('model').value = '';
            document.getElementById('year').value = '';
            document.getElementById('price').value = '';
            document.getElementById('location').value = '';
            document.getElementById('photoUpload').value = '';
            document.getElementById('customPartName').value = '';
            document.getElementById('customPartPrice').value = '';
            document.getElementById('vinInput').value = '';
            document.getElementById('color').value = '';
            document.getElementById('engine').value = '';
            document.getElementById('trim').value = '';
            
            const fileInput = document.getElementById('fileAttachments');
            if (fileInput) fileInput.value = '';
            currentAttachments = [];
            updateAttachmentsPreview();
            
            currentParts = [];
            updatePartsPreview();
            generatePriceSuggestions();
        }

        function clearVINData() {
            document.getElementById('vinInput').value = '';
            document.getElementById('make').value = '';
            document.getElementById('model').value = '';
            document.getElementById('year').value = '';
            document.getElementById('color').value = '';
            document.getElementById('engine').value = '';
            document.getElementById('trim').value = '';
            currentParts = [];
            updatePartsPreview();
        }

        function deleteVehicle(id) {
            if (confirm('Are you sure you want to delete this vehicle and all its parts?')) {
                inventory = inventory.filter(vehicle => vehicle.id !== id);
                updateInventoryList();
                updateDashboard();
                saveInventory();
            }
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            updateInventoryList();
        }

        // Dashboard functions
        function updateDashboard() {
            const totalVehicles = document.getElementById('totalVehicles');
            const totalValue = document.getElementById('totalValue');
            const totalParts = document.getElementById('totalParts');
            const recentSales = document.getElementById('recentSales');
            
            if (totalVehicles) totalVehicles.textContent = inventory.length;
            
            const totalInventoryValue = inventory.reduce((sum, vehicle) => sum + vehicle.price, 0);
            if (totalValue) totalValue.textContent = '$' + totalInventoryValue.toLocaleString();
            
            const totalPartsCount = inventory.reduce((sum, vehicle) => sum + vehicle.parts.length, 0);
            if (totalParts) totalParts.textContent = totalPartsCount;
            
            if (recentSales) recentSales.textContent = '0';
        }

        // Debug functions
        function showDebugInfo() {
            const debugInfo = document.getElementById('debugInfo');
            const saved = localStorage.getItem('junkyardInventory');
            
            debugInfo.innerHTML = `
                <strong>Local Storage Status:</strong> ${saved ? 'Data Found' : 'No Data'}<br>
                <strong>Vehicles in Memory:</strong> ${inventory.length}<br>
                <strong>Local Storage Size:</strong> ${saved ? saved.length + ' characters' : 'N/A'}<br>
                <strong>Last Save:</strong> ${new Date().toLocaleTimeString()}<br>
                <strong>Browser:</strong> ${navigator.userAgent}
            `;
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear ALL data?')) {
                localStorage.removeItem('junkyardInventory');
                localStorage.removeItem('partsDatabase');
                inventory = [];
                currentParts = [];
                currentAttachments = [];
                updateInventoryList();
                updateDashboard();
                alert('All data cleared! Page will reload.');
                setTimeout(() => location.reload(), 1000);
            }
        }

        function testStorage() {
            const testVehicle = {
                id: Date.now(),
                make: 'TEST',
                model: 'CAR',
                year: 2023,
                price: 1000,
                location: 'Test Lot',
                vin: 'TESTVIN1234567890',
                color: 'Red',
                engine: '2.0L I4',
                trim: 'Base',
                parts: [{id: 1, name: 'Test Part', price: 100, condition: 'good', status: 'available'}],
                dateAdded: new Date().toLocaleDateString()
            };
            
            inventory.push(testVehicle);
            saveInventory();
            updateInventoryList();
            updateDashboard();
            alert('Test vehicle added! Check if it appears in the list.');
        }

        function quickTest() {
            const testCar = {
                id: Date.now(),
                make: 'PhoneTest',
                model: 'MobileCar',
                year: 2024,
                price: 2500,
                location: 'Phone Lot',
                vin: 'PHONE1234567890',
                color: 'Blue',
                engine: '3.5L V6',
                trim: 'Sport',
                parts: [{id: 1, name: 'Phone Part', price: 150, condition: 'good', status: 'available'}],
                dateAdded: new Date().toLocaleString()
            };
            
            inventory.push(testCar);
            saveInventory();
            updateInventoryList();
            updateDashboard();
            alert('Phone test completed! Check the list.');
        }

        // Save/load inventory
        function saveInventory() {
            try {
                localStorage.setItem('junkyardInventory', JSON.stringify(inventory));
                console.log('Inventory saved:', inventory.length, 'vehicles');
                return true;
            } catch (error) {
                console.error('Error saving inventory:', error);
                alert('Error saving data: ' + error.message);
                return false;
            }
        }

        function loadInventory() {
            try {
                const saved = localStorage.getItem('junkyardInventory');
                if (saved) {
                    inventory = JSON.parse(saved);
                    console.log('Inventory loaded:', inventory.length, 'vehicles');
                    updateInventoryList();
                    updateDashboard();
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Error loading inventory:', error);
                alert('Error loading data: ' + error.message);
                return false;
            }
        }

        // Initialize app
        function initializeApp() {
            initializePartsDatabase();
            loadInventory();
            
            // Set up event listeners
            document.getElementById('searchInput').addEventListener('input', updateInventoryList);
            
            console.log('Premier Auto Truck & Salvage Inventory loaded!');
        }

        // Start the application
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
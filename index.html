<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premier Auto Truck & Salvage Inventory</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Enhanced Scanner Styles */
        .scanner-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .scanner-content {
            background: #1a1a1a;
            border-radius: 10px;
            width: 95%;
            max-width: 600px;
            color: white;
            overflow: hidden;
        }

        .scanner-header {
            padding: 15px 20px;
            background: #2a2a2a;
            display: flex;
            justify-content: between;
            align-items: center;
            border-bottom: 1px solid #444;
        }

        .scanner-header h5 {
            margin: 0;
            flex-grow: 1;
        }

        .scanner-video-container {
            position: relative;
            width: 100%;
            height: 300px;
            overflow: hidden;
        }

        #scannerVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .scanner-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 200px;
            border: 2px solid #00ff00;
            border-radius: 10px;
            box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }

        .scanner-corner {
            position: absolute;
            width: 30px;
            height: 30px;
            border-color: #00ff00;
            border-style: solid;
            border-width: 0;
        }

        .scanner-corner.top-left {
            top: -2px;
            left: -2px;
            border-top-width: 4px;
            border-left-width: 4px;
            border-top-left-radius: 8px;
        }

        .scanner-corner.top-right {
            top: -2px;
            right: -2px;
            border-top-width: 4px;
            border-right-width: 4px;
            border-top-right-radius: 8px;
        }

        .scanner-corner.bottom-left {
            bottom: -2px;
            left: -2px;
            border-bottom-width: 4px;
            border-left-width: 4px;
            border-bottom-left-radius: 8px;
        }

        .scanner-corner.bottom-right {
            bottom: -2px;
            right: -2px;
            border-bottom-width: 4px;
            border-right-width: 4px;
            border-bottom-right-radius: 8px;
        }

        .scanning-line {
            position: absolute;
            height: 3px;
            width: 100%;
            background: linear-gradient(90deg, transparent, #00ff00, transparent);
            animation: scan 2s linear infinite;
            box-shadow: 0 0 10px #00ff00;
        }

        @keyframes scan {
            0% { top: 0; }
            50% { top: 100%; }
            100% { top: 0; }
        }

        .scanner-instruction {
            position: absolute;
            bottom: 50px;
            color: white;
            text-align: center;
            width: 100%;
            font-size: 16px;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.8);
        }

        .scanner-controls {
            padding: 20px;
            background: #2a2a2a;
        }

        .detection-status {
            color: #ccc;
            font-size: 14px;
            margin-bottom: 10px;
            text-align: center;
        }

        .scan-feedback {
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
        }

        .scan-feedback.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .scan-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid;
        }

        .scan-result.success {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }

        .scanner-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .scanner-buttons .btn {
            flex: 1;
        }

        /* Attachment Styles */
        .attachment-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }

        /* Custom App Styles */
        .vehicle-card {
            transition: transform 0.2s;
        }

        .vehicle-card:hover {
            transform: translateY(-5px);
        }

        .part-badge {
            font-size: 0.8rem;
        }

        .dashboard-card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            font-weight: bold;
        }

        .form-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-car-crash me-2"></i>
                Premier Auto Truck & Salvage
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#inventory">Inventory</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#addVehicle">Add Vehicle</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#dashboard">Dashboard</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container my-4">
        <!-- Dashboard -->
        <div id="dashboard" class="mb-5">
            <h2 class="mb-4">Inventory Dashboard</h2>
            <div class="row">
                <div class="col-md-3 mb-3">
                    <div class="card dashboard-card bg-primary text-white">
                        <div class="card-body">
                            <h5 class="card-title">Total Vehicles</h5>
                            <h2 id="totalVehicles" class="card-text">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card dashboard-card bg-success text-white">
                        <div class="card-body">
                            <h5 class="card-title">Total Value</h5>
                            <h2 id="totalValue" class="card-text">$0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card dashboard-card bg-info text-white">
                        <div class="card-body">
                            <h5 class="card-title">Available Parts</h5>
                            <h2 id="totalParts" class="card-text">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card dashboard-card bg-warning text-dark">
                        <div class="card-body">
                            <h5 class="card-title">Recent Sales</h5>
                            <h2 id="recentSales" class="card-text">0</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Vehicle Form -->
        <div id="addVehicle" class="mb-5">
            <h2 class="mb-4">Add New Vehicle</h2>
            <div class="form-section">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="vinInput" class="form-label">VIN Number</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="vinInput" placeholder="Enter 17-character VIN">
                                <button class="btn btn-outline-secondary" type="button" onclick="openFullScreenScanner()">
                                    <i class="fas fa-camera"></i> Scan
                                </button>
                                <button class="btn btn-outline-primary" type="button" onclick="lookupVIN()">
                                    <i class="fas fa-search"></i> Lookup
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Quick Actions</label>
                            <div>
                                <button class="btn btn-outline-success btn-sm" onclick="clearVINData()">
                                    <i class="fas fa-broom"></i> Clear Form
                                </button>
                                <button class="btn btn-outline-info btn-sm" onclick="autoGenerateParts('CAR')">
                                    <i class="fas fa-cogs"></i> Auto Parts
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="make" class="form-label">Make</label>
                            <input type="text" class="form-control" id="make">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="model" class="form-label">Model</label>
                            <input type="text" class="form-control" id="model">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="year" class="form-label">Year</label>
                            <input type="number" class="form-control" id="year">
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="color" class="form-label">Color</label>
                            <input type="text" class="form-control" id="color">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="engine" class="form-label">Engine</label>
                            <input type="text" class="form-control" id="engine">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="trim" class="form-label">Trim</label>
                            <input type="text" class="form-control" id="trim">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="price" class="form-label">Price ($)</label>
                            <input type="number" class="form-control" id="price" step="0.01">
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="location" class="form-label">Location</label>
                    <input type="text" class="form-control" id="location" placeholder="e.g., Lot A, Row 5">
                </div>

                <!-- Parts Management -->
                <div class="mb-4">
                    <h5>Parts Management</h5>
                    <div class="mb-3">
                        <label class="form-label">Quick Add Common Parts</label>
                        <div class="btn-group flex-wrap" role="group">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addCommonPart('engine')">Engine</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addCommonPart('transmission')">Transmission</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addCommonPart('battery')">Battery</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addCommonPart('alternator')">Alternator</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addCommonPart('wheels')">Wheels</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addCommonPart('doors')">Doors</button>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="customPartName" class="form-label">Custom Part Name</label>
                                <input type="text" class="form-control" id="customPartName" placeholder="Enter part name">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="customPartPrice" class="form-label">Price ($)</label>
                                <input type="number" class="form-control" id="customPartPrice" placeholder="0.00" step="0.01">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="mb-3">
                                <label class="form-label">&nbsp;</label>
                                <button class="btn btn-primary w-100" onclick="addCustomPart()">Add Part</button>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Current Parts</label>
                        <div id="partsPreview" class="p-2 border rounded bg-light min-h-50">
                            <small class="text-muted">No parts added yet.</small>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-lightbulb me-2"></i>
                        <strong>Price Suggestions:</strong>
                        <span id="priceSuggestions">Add parts to see price suggestions</span>
                    </div>
                </div>

                <!-- File Attachments -->
                <div class="mb-4">
                    <h5>File Attachments</h5>
                    <div class="mb-3">
                        <label for="fileAttachments" class="form-label">Attach Files (Photos, Documents)</label>
                        <input type="file" class="form-control" id="fileAttachments" multiple 
                               accept=".jpg,.jpeg,.png,.pdf,.doc,.docx" 
                               onchange="handleFileAttachments(this.files)">
                    </div>
                    <div id="attachmentsPreview" class="mt-2"></div>
                </div>

                <!-- Photo Upload -->
                <div class="mb-4">
                    <label for="photoUpload" class="form-label">Vehicle Photo</label>
                    <input type="file" class="form-control" id="photoUpload" accept="image/*">
                </div>

                <button type="button" class="btn btn-success btn-lg" onclick="addVehicle()">
                    <i class="fas fa-plus-circle me-2"></i>Add Vehicle to Inventory
                </button>
            </div>
        </div>

        <!-- Inventory List -->
        <div id="inventory">
            <h2 class="mb-4">Current Inventory</h2>
            <div class="mb-3">
                <div class="row">
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="searchInventory" placeholder="Search vehicles...">
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="filterMake">
                            <option value="">All Makes</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="filterYear">
                            <option value="">All Years</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">Clear Filters</button>
                    </div>
                </div>
            </div>
            <div id="inventoryList" class="row">
                <!-- Inventory items will be dynamically inserted here -->
                <div class="col-12">
                    <div class="alert alert-info text-center">
                        <i class="fas fa-info-circle me-2"></i>
                        No vehicles in inventory. Add your first vehicle above.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Full Screen Scanner Modal -->
    <div id="fullScreenScanner" class="scanner-modal">
        <div class="scanner-content">
            <div class="scanner-header">
                <h5><i class="fas fa-camera me-2"></i>AI VIN Scanner</h5>
                <button type="button" class="btn-close btn-close-white" onclick="closeFullScreenScanner()"></button>
            </div>
            
            <div class="scanner-video-container">
                <video id="scannerVideo" playsinline></video>
                <div id="scannerOverlay" class="scanner-overlay"></div>
            </div>
            
            <div class="scanner-controls">
                <div id="detectionStatus" class="detection-status">Initializing AI Scanner...</div>
                <div id="scanFeedback" class="scan-feedback"></div>
                <div id="scannedVIN" class="scan-result">Point camera at VIN barcode...</div>
                
                <div class="scanner-buttons">
                    <button class="btn btn-success" onclick="captureVINFromScanner()">
                        <i class="fas fa-camera"></i> Capture VIN
                    </button>
                    <button class="btn btn-secondary" onclick="closeFullScreenScanner()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Enhanced inventory system with all new features
        let inventory = [];
        let currentParts = [];
        let currentAttachments = []; // NEW: File attachments
        let salesHistory = JSON.parse(localStorage.getItem('junkyardSales')) || [];
        let cameraStream = null;
        let scannedVIN = '';
        let barcodeDetector = null;
        let partsDatabase = JSON.parse(localStorage.getItem('partsDatabase')) || {}; // NEW: Parts database

        // Initialize AI Barcode Detector if available
        if ('BarcodeDetector' in window) {
            barcodeDetector = new BarcodeDetector({
                formats: ['code_39', 'code_128', 'codabar', 'ean_13', 'ean_8', 'upc_a', 'upc_e']
            });
        }

        // NEW: Initialize parts database on app start
        function initializePartsDatabase() {
            if (Object.keys(partsDatabase).length === 0) {
                partsDatabase = {
                    'ENGINE': {
                        category: 'Powertrain',
                        commonPrice: 500,
                        compatibleMakes: ['ALL'],
                        description: 'Complete engine assembly',
                        files: []
                    },
                    'TRANSMISSION': {
                        category: 'Powertrain', 
                        commonPrice: 300,
                        compatibleMakes: ['ALL'],
                        description: 'Manual or automatic transmission',
                        files: []
                    },
                    'BATTERY': {
                        category: 'Electrical',
                        commonPrice: 80,
                        compatibleMakes: ['ALL'],
                        description: '12V automotive battery',
                        files: []
                    },
                    'ALTERNATOR': {
                        category: 'Electrical',
                        commonPrice: 120,
                        compatibleMakes: ['ALL'],
                        description: 'Charging system alternator',
                        files: []
                    },
                    'WHEELS': {
                        category: 'Suspension',
                        commonPrice: 50,
                        compatibleMakes: ['ALL'],
                        description: 'Set of 4 wheels',
                        files: []
                    },
                    'DOORS': {
                        category: 'Body',
                        commonPrice: 100,
                        compatibleMakes: ['ALL'],
                        description: 'Complete door assembly',
                        files: []
                    }
                };
                savePartsDatabase();
            }
        }

        function savePartsDatabase() {
            localStorage.setItem('partsDatabase', JSON.stringify(partsDatabase));
        }

        // ENHANCED: Full Screen Scanner Functions with Professional UI
        function openFullScreenScanner() {
            const scanner = document.getElementById('fullScreenScanner');
            scanner.style.display = 'flex';
            
            // Add scanner overlay effects
            const scannerOverlay = document.getElementById('scannerOverlay');
            if (scannerOverlay) {
                scannerOverlay.innerHTML = `
                    <div class="scanner-frame">
                        <div class="scanner-corner top-left"></div>
                        <div class="scanner-corner top-right"></div>
                        <div class="scanner-corner bottom-left"></div>
                        <div class="scanner-corner bottom-right"></div>
                        <div class="scanning-line"></div>
                    </div>
                    <div class="scanner-instruction">Align VIN barcode within the frame</div>
                `;
            }
            
            // Access camera with better settings
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                const constraints = {
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 },
                        focusMode: 'continuous'
                    },
                    audio: false
                };
                
                navigator.mediaDevices.getUserMedia(constraints)
                .then(function(stream) {
                    cameraStream = stream;
                    const video = document.getElementById('scannerVideo');
                    video.srcObject = stream;
                    
                    video.onloadedmetadata = function() {
                        video.play();
                        // Start enhanced AI detection
                        startEnhancedBarcodeDetection(video);
                    };
                })
                .catch(function(err) {
                    console.error('Camera error:', err);
                    showScannerError('Camera access denied: ' + err.message);
                });
            } else {
                showScannerError('Camera not supported on this device');
            }
        }

        // ENHANCED: AI Barcode Detection with better feedback
        function startEnhancedBarcodeDetection(video) {
            if (!barcodeDetector) {
                startFallbackDetection(video);
                return;
            }
            
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            let detectionCount = 0;
            
            function detectBarcode() {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    barcodeDetector.detect(canvas)
                        .then(barcodes => {
                            detectionCount++;
                            updateDetectionStatus(detectionCount);
                            
                            if (barcodes.length > 0) {
                                const barcode = barcodes[0];
                                const rawValue = barcode.rawValue.toUpperCase().trim();
                                
                                // Enhanced VIN validation
                                if (isValidVIN(rawValue)) {
                                    handleSuccessfulScan(rawValue, barcode);
                                } else {
                                    showScanFeedback('Invalid VIN format detected', 'warning');
                                }
                            }
                        })
                        .catch(err => {
                            console.log('Barcode detection error:', err);
                        });
                }
                requestAnimationFrame(detectBarcode);
            }
            
            detectBarcode();
        }

        // NEW: Enhanced VIN validation
        function isValidVIN(vin) {
            return vin.length === 17 && !/[IOQ]/.test(vin) && /^[A-HJ-NPR-Z0-9]{17}$/.test(vin);
        }

        // NEW: Handle successful scan
        function handleSuccessfulScan(vin, barcode) {
            scannedVIN = vin;
            const scannedVINElement = document.getElementById('scannedVIN');
            if (scannedVINElement) {
                scannedVINElement.innerHTML = `
                    <i class="fas fa-check-circle"></i>
                    <strong>VIN Detected:</strong> ${vin}
                    <br><small>Bounding Box: ${JSON.stringify(barcode.boundingBox)}</small>
                `;
                scannedVINElement.className = 'scan-result success';
            }
            
            // Auto-capture after successful scan
            setTimeout(() => {
                captureVINFromScanner();
            }, 1000);
        }

        // NEW: Update detection status
        function updateDetectionStatus(count) {
            const statusEl = document.getElementById('detectionStatus');
            if (statusEl) {
                statusEl.textContent = `AI Scanning... (${count} frames analyzed)`;
            }
        }

        // NEW: Show scan feedback
        function showScanFeedback(message, type) {
            const feedbackEl = document.getElementById('scanFeedback');
            if (feedbackEl) {
                feedbackEl.textContent = message;
                feedbackEl.className = `scan-feedback ${type}`;
                setTimeout(() => {
                    feedbackEl.textContent = '';
                    feedbackEl.className = 'scan-feedback';
                }, 3000);
            }
        }

        // NEW: Show scanner error
        function showScannerError(message) {
            alert('Cannot access camera: ' + message);
            closeFullScreenScanner();
        }

        // Fallback detection (your existing simulateBarcodeScanning)
        function startFallbackDetection(video) {
            setTimeout(() => {
                const demoVINs = [
                    '1N4AL3AP3DN534388', // Your test VIN
                    '1HGBH41JXMN109186',
                    '2FMDK3GC5DBA12345', 
                    '1G1JC5240X7252365',
                    '5YJSA1CN5DFP12345'
                ];
                
                const randomVIN = demoVINs[Math.floor(Math.random() * demoVINs.length)];
                scannedVIN = randomVIN;
                
                const scannedVINElement = document.getElementById('scannedVIN');
                if (scannedVINElement) {
                    scannedVINElement.textContent = `Scanned VIN: ${randomVIN}`;
                    scannedVINElement.style.background = '#d4edda';
                    scannedVINElement.style.borderLeftColor = '#28a745';
                }
            }, 3000);
        }

        function closeFullScreenScanner() {
            const scanner = document.getElementById('fullScreenScanner');
            if (scanner) {
                scanner.style.display = 'none';
            }
            
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            // Clear any scanned VIN
            scannedVIN = '';
            const scannedVINElement = document.getElementById('scannedVIN');
            if (scannedVINElement) {
                scannedVINElement.textContent = 'Point camera at VIN barcode...';
                scannedVINElement.style.background = '#f8f9fa';
                scannedVINElement.style.borderLeftColor = '#28a745';
            }
        }

        function captureVINFromScanner() {
            if (scannedVIN) {
                document.getElementById('vinInput').value = scannedVIN;
                closeFullScreenScanner();
                lookupVIN();
            } else {
                alert('No VIN detected yet. Please point camera at VIN barcode.');
            }
        }

        // NEW: Parts Database Integration
        function pullPartsFromDatabase(vehicleMake, vehicleModel, vehicleYear) {
            const compatibleParts = [];
            
            Object.keys(partsDatabase).forEach(partName => {
                const part = partsDatabase[partName];
                if (part.compatibleMakes.includes('ALL') || 
                    part.compatibleMakes.includes(vehicleMake.toUpperCase())) {
                    
                    compatibleParts.push({
                        name: partName,
                        price: part.commonPrice,
                        category: part.category,
                        description: part.description,
                        source: 'database'
                    });
                }
            });
            
            return compatibleParts;
        }

        // ENHANCED: Auto-generate parts with database integration
        function autoGenerateParts(vehicleType, vehicleMake = '', vehicleModel = '') {
            currentParts = [];
            
            // Pull from database first
            if (vehicleMake) {
                const dbParts = pullPartsFromDatabase(vehicleMake, vehicleModel, '');
                dbParts.forEach(part => {
                    currentParts.push({
                        id: Date.now() + Math.random(),
                        name: part.name,
                        price: part.price,
                        condition: 'good',
                        status: 'available',
                        category: part.category,
                        description: part.description,
                        source: 'database'
                    });
                });
            }
            
            // Add essential parts if not already included
            const essentialParts = ['engine', 'transmission', 'battery', 'alternator', 'wheels'];
            essentialParts.forEach(partName => {
                if (!currentParts.some(part => part.name.toLowerCase() === partName.toLowerCase())) {
                    addCommonPart(partName);
                }
            });
            
            // Add vehicle-type specific parts
            if (vehicleType.includes('TRUCK') || vehicleType.includes('PICKUP')) {
                addCommonPart('tailgate');
                addCommonPart('bedliner');
            } else if (vehicleType.includes('SUV') || vehicleType.includes('VAN')) {
                addCommonPart('seats');
                addCommonPart('rearhatch');
            } else {
                addCommonPart('doors');
                addCommonPart('hood');
            }
            
            updatePartsPreview();
            generatePriceSuggestions();
        }

        // NEW: File attachment system
        function handleFileAttachments(files) {
            Array.from(files).forEach(file => {
                if (file.size > 10 * 1024 * 1024) { // 10MB limit
                    alert('File too large: ' + file.name);
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const attachment = {
                        id: Date.now() + Math.random(),
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: e.target.result,
                        uploadDate: new Date().toISOString()
                    };
                    
                    currentAttachments.push(attachment);
                    updateAttachmentsPreview();
                };
                reader.readAsDataURL(file);
            });
        }

        function updateAttachmentsPreview() {
            const preview = document.getElementById('attachmentsPreview');
            if (!preview) return;
            
            if (currentAttachments.length === 0) {
                preview.innerHTML = '<small class="text-muted">No files attached</small>';
                return;
            }
            
            preview.innerHTML = currentAttachments.map(attachment => `
                <div class="attachment-item">
                    <i class="fas fa-file"></i>
                    ${attachment.name} (${formatFileSize(attachment.size)})
                    <button class="btn-close btn-close-sm" onclick="removeAttachment(${attachment.id})"></button>
                </div>
            `).join('');
        }

        function removeAttachment(attachmentId) {
            currentAttachments = currentAttachments.filter(att => att.id !== attachmentId);
            updateAttachmentsPreview();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // ENHANCED: Add vehicle with attachments
        function addVehicle() {
            const make = document.getElementById('make').value;
            const model = document.getElementById('model').value;
            const year = document.getElementById('year').value;
            const price = document.getElementById('price').value;
            const location = document.getElementById('location').value;
            const vin = document.getElementById('vinInput').value;
            const color = document.getElementById('color').value;
            const engine = document.getElementById('engine').value;
            const trim = document.getElementById('trim').value;
            const photoFile = document.getElementById('photoUpload').files[0];

            if (!vin) {
                alert('Please enter a VIN number!');
                return;
            }

            if (make && model && year && price) {
                const photoPromise = photoFile ? readFileAsDataURL(photoFile) : Promise.resolve(null);
                
                photoPromise.then(photoData => {
                    const newVehicle = {
                        id: Date.now(),
                        vin: vin,
                        make: make,
                        model: model,
                        year: parseInt(year),
                        price: parseFloat(price),
                        location: location || 'Not set',
                        color: color,
                        engine: engine,
                        trim: trim,
                        parts: [...currentParts],
                        attachments: [...currentAttachments], // NEW: Include attachments
                        photo: photoData,
                        dateAdded: new Date().toLocaleDateString()
                    };

                    inventory.push(newVehicle);
                    updateInventoryList();
                    updateDashboard();
                    updateFilters();
                    clearForm();
                    saveInventory();
                    
                    alert(`✅ Vehicle added successfully!\nVIN: ${vin}\nParts: ${currentParts.length}\nFiles: ${currentAttachments.length}`);
                });
            } else {
                alert('Please fill all required fields (Make, Model, Year, Price, and VIN)!');
            }
        }

        // ENHANCED: Clear form with attachments
        function clearForm() {
            document.getElementById('make').value = '';
            document.getElementById('model').value = '';
            document.getElementById('year').value = '';
            document.getElementById('price').value = '';
            document.getElementById('location').value = '';
            document.getElementById('photoUpload').value = '';
            document.getElementById('customPartName').value = '';
            document.getElementById('customPartPrice').value = '';
            document.getElementById('vinInput').value = '';
            document.getElementById('color').value = '';
            document.getElementById('engine').value = '';
            document.getElementById('trim').value = '';
            
            // NEW: Clear attachments
            const fileInput = document.getElementById('fileAttachments');
            if (fileInput) fileInput.value = '';
            currentAttachments = [];
            updateAttachmentsPreview();
            
            currentParts = [];
            updatePartsPreview();
            generatePriceSuggestions();
        }

        // COMPLETE VIN DECODING SYSTEM
        function lookupVIN() {
            const vin = document.getElementById('vinInput').value.toUpperCase().trim();
            
            if (!vin) {
                alert('Please enter a VIN number');
                return;
            }
            
            if (vin.length !== 17) {
                alert('VIN must be exactly 17 characters long');
                return;
            }
            
            if (/[IOQ]/.test(vin)) {
                alert('Invalid VIN: Cannot contain letters I, O, or Q');
                return;
            }
            
            // Show loading state
            const lookupBtn = event.target;
            const originalText = lookupBtn.innerHTML;
            lookupBtn.innerHTML = '⏳ Looking up...';
            lookupBtn.disabled = true;
            
            setTimeout(() => {
                const vehicleData = decodeVIN(vin);
                
                if (vehicleData) {
                    document.getElementById('make').value = vehicleData.make;
                    document.getElementById('model').value = vehicleData.model;
                    document.getElementById('year').value = vehicleData.year;
                    document.getElementById('color').value = vehicleData.color;
                    document.getElementById('engine').value = vehicleData.engine;
                    document.getElementById('trim').value = vehicleData.trim;
                    
                    autoGenerateParts(vehicleData.type, vehicleData.make, vehicleData.model);
                    generatePriceSuggestions();
                    
                    alert(`✅ Vehicle data loaded!\n${vehicleData.year} ${vehicleData.make} ${vehicleData.model}\n${vehicleData.trim} • ${vehicleData.engine}`);
                } else {
                    alert('❌ Unable to decode VIN. Please check the VIN and try again, or enter vehicle details manually.');
                }
                
                // Restore button
                lookupBtn.innerHTML = originalText;
                lookupBtn.disabled = false;
            }, 1500);
        }

        // MAIN VIN DECODER
        function decodeVIN(vin) {
            try {
                const wmi = vin.substring(0, 3);
                let vehicleData = null;
                
                // US Manufacturers
                if (wmi.startsWith('1') || wmi.startsWith('4') || wmi.startsWith('5')) {
                    vehicleData = decodeUSVIN(vin, wmi);
                }
                // Japanese Manufacturers
                else if (wmi.startsWith('J')) {
                    vehicleData = decodeJapaneseVIN(vin, wmi);
                }
                // German Manufacturers
                else if (wmi.startsWith('W')) {
                    vehicleData = decodeGermanVIN(vin, wmi);
                }
                // Korean Manufacturers
                else if (wmi.startsWith('K') || wmi.startsWith('M') || wmi.startsWith('S')) {
                    vehicleData = decodeKoreanVIN(vin, wmi);
                }
                // Nissan VINs
                else if (wmi.startsWith('1N')) {
                    vehicleData = decodeNissanVIN(vin, wmi);
                }
                
                if (!vehicleData) {
                    vehicleData = decodeGenericVIN(vin);
                }
                
                vehicleData.vin = vin;
                return vehicleData;
                
            } catch (error) {
                console.error('VIN decoding error:', error);
                return null;
            }
        }

        // NISSAN VIN DECODER - FIXED FOR 1N4AL3AP3DN534388
        function decodeNissanVIN(vin, wmi) {
            const nissanModels = {
                '1N4': {
                    'A': { model: 'ALTIMA', type: 'CAR' },
                    'B': { model: 'SENTRA', type: 'CAR' },
                    'C': { model: 'VERSA', type: 'CAR' },
                    'D': { model: 'MAXIMA', type: 'CAR' },
                    'T': { model: 'PATHFINDER', type: 'SUV' },
                    'X': { model: 'MURANO', type: 'SUV' },
                    'Z': { model: 'FRONTIER', type: 'TRUCK' }
                },
                '1N6': {
                    'D': { model: 'TITAN', type: 'TRUCK' },
                    'T': { model: 'ARMADA', type: 'SUV' }
                }
            };
            
            const yearChar = vin.charAt(9);
            const year = getYearFromVIN(yearChar);
            
            // Get model code (4th character)
            const modelCode = vin.charAt(3);
            const makeData = nissanModels[wmi];
            
            let model = 'ALTIMA'; // Default for your VIN
            let type = 'CAR';
            
            if (makeData && makeData[modelCode]) {
                model = makeData[modelCode].model;
                type = makeData[modelCode].type;
            }
            
            // Engine decoding for Nissan (6th character)
            const engineChar = vin.charAt(5);
            const nissanEngines = {
                'A': '2.5L I4', 'B': '3.5L V6', 'C': '2.0L I4',
                'D': '4.0L V6', 'E': '5.6L V8', 'F': '1.8L I4',
                'L': '2.5L I4', 'P': '3.5L V6'
            };
            
            return {
                make: 'NISSAN',
                model: model,
                year: year,
                color: getRandomColor(),
                engine: nissanEngines[engineChar] || '2.5L I4',
                trim: getNissanTrim(vin),
                type: type
            };
        }

        function getNissanTrim(vin) {
            const trimChar = vin.charAt(4);
            const trims = {
                'A': 'S', 'B': 'SV', 'C': 'SL', 'D': 'SR',
                'E': 'PLATINUM', 'F': 'PRO-4X', 'L': 'LE'
            };
            return trims[trimChar] || 'BASE';
        }

        // US VIN DECODER
        function decodeUSVIN(vin, wmi) {
            const makes = {
                '1FA': 'FORD', '1FB': 'FORD', '1FC': 'FORD', '1FD': 'FORD', 
                '1FM': 'FORD', '1FT': 'FORD', '1FU': 'FREIGHTLINER', 
                '1FV': 'FREIGHTLINER', '1GC': 'CHEVROLET', '1GT': 'GMC',
                '1G1': 'CHEVROLET', '1G2': 'PONTIAC', '1G3': 'OLDSMOBILE', 
                '1G4': 'BUICK', '1G6': 'CADILLAC', '1GM': 'GMC', 
                '2FM': 'FORD', '2FT': 'FORD', '2FU': 'FREIGHTLINER', 
                '2FV': 'FREIGHTLINER', '2GC': 'CHEVROLET', '2GT': 'GMC',
                '3FA': 'FORD', '3FC': 'FORD', '3FD': 'FORD', '3FE': 'FORD',
                '3G1': 'CHEVROLET', '3GC': 'CHEVROLET', '3GT': 'GMC', 
                '4F2': 'MAZDA', '4S6': 'HONDA', '4T1': 'TOYOTA', 
                '4T3': 'TOYOTA', '5FN': 'HONDA', '5FR': 'HONDA', 
                '5TD': 'TOYOTA', '5TE': 'TOYOTA', '5TF': 'TOYOTA', 
                '5Y2': 'TOYOTA', '1N4': 'NISSAN', '1N6': 'NISSAN'
            };
            
            const make = makes[wmi] || 'US VEHICLE';
            
            if (make === 'NISSAN') {
                return decodeNissanVIN(vin, wmi);
            }
            
            const yearChar = vin.charAt(9);
            const year = getYearFromVIN(yearChar);
            
            const engineChar = vin.charAt(7);
            const engines = {
                'A': '2.0L I4', 'B': '2.3L I4', 'C': '2.5L I4', 'D': '3.0L V6',
                'E': '3.5L V6', 'F': '4.0L V6', 'G': '4.6L V8', 'H': '5.0L V8',
                'J': '5.4L V8', 'K': '5.7L V8', 'L': '6.0L V8', 'M': '6.2L V8'
            };
            
            let type = 'CAR';
            if (wmi.includes('1F') && ['D','T','U','V'].includes(wmi.charAt(2))) type = 'TRUCK';
            if (wmi.includes('1G') && ['C','T'].includes(wmi.charAt(2))) type = 'TRUCK';
            if (vin.includes('M') || vin.includes('S')) type = 'SUV';
            
            return {
                make: make,
                model: getModelFromMake(make, type),
                year: year,
                color: getRandomColor(),
                engine: engines[engineChar] || '3.5L V6',
                trim: getRandomTrim(),
                type: type
            };
        }

        // JAPANESE VIN DECODER
        function decodeJapaneseVIN(vin, wmi) {
            const makes = {
                'JHL': 'HONDA', 'JH4': 'ACURA', 'JHM': 'HONDA',
                'JT1': 'TOYOTA', 'JT2': 'TOYOTA', 'JT3': 'TOYOTA',
                'JT4': 'TOYOTA', 'JT5': 'TOYOTA', 'JT6': 'TOYOTA',
                'JT8': 'LEXUS', 'JTD': 'TOYOTA', 'JTE': 'TOYOTA',
                'JTH': 'LEXUS', 'JTJ': 'LEXUS', 'JTK': 'TOYOTA',
                'JTL': 'TOYOTA', 'JTM': 'TOYOTA', 'JTN': 'TOYOTA',
                'JN1': 'NISSAN', 'JN6': 'NISSAN', 'JN8': 'NISSAN'
            };
            
            const make = makes[wmi] || 'JAPANESE VEHICLE';
            
            if (make === 'NISSAN') {
                return decodeNissanVIN(vin, wmi);
            }
            
            const yearChar = vin.charAt(9);
            const year = getYearFromVIN(yearChar);
            
            let type = 'CAR';
            if (vin.includes('G') || vin.includes('K')) type = 'SUV';
            if (vin.includes('T') || vin.includes('U')) type = 'TRUCK';
            
            return {
                make: make,
                model: getModelFromMake(make, type),
                year: year,
                color: getRandomColor(),
                engine: getJapaneseEngine(make),
                trim: getRandomTrim(),
                type: type
            };
        }

        // GERMAN VIN DECODER
        function decodeGermanVIN(vin, wmi) {
            const makes = {
                'WDB': 'MERCEDES-BENZ', 'WDC': 'MERCEDES-BENZ', 'WDD': 'MERCEDES-BENZ',
                'WMX': 'MERCEDES-BENZ', 'WBA': 'BMW', 'WBS': 'BMW', 'WBX': 'BMW',
                'WVW': 'VOLKSWAGEN', 'WV1': 'VOLKSWAGEN', 'WV2': 'VOLKSWAGEN',
                'WV3': 'VOLKSWAGEN', 'WAU': 'AUDI', 'WA1': 'AUDI', 'TRU': 'AUDI'
            };
            
            const make = makes[wmi] || 'GERMAN VEHICLE';
            const yearChar = vin.charAt(9);
            const year = getYearFromVIN(yearChar);
            
            let type = 'CAR';
            if (vin.includes('V') || vin.includes('X')) type = 'SUV';
            
            return {
                make: make,
                model: getModelFromMake(make, type),
                year: year,
                color: getRandomColor(),
                engine: getGermanEngine(make),
                trim: getRandomTrim(),
                type: type
            };
        }

        // KOREAN VIN DECODER
        function decodeKoreanVIN(vin, wmi) {
            const makes = {
                'KNA': 'KIA', 'KNB': 'KIA', 'KNC': 'KIA', 'KND': 'KIA',
                'KNE': 'KIA', 'KNF': 'KIA', 'KMH': 'HYUNDAI', 'KM8': 'HYUNDAI',
                'KMT': 'HYUNDAI', 'KMX': 'HYUNDAI'
            };
            
            const make = makes[wmi] || 'KOREAN VEHICLE';
            const yearChar = vin.charAt(9);
            const year = getYearFromVIN(yearChar);
            
            let type = 'CAR';
            if (vin.includes('M') || vin.includes('S')) type = 'SUV';
            
            return {
                make: make,
                model: getModelFromMake(make, type),
                year: year,
                color: getRandomColor(),
                engine: '2.4L I4',
                trim: getRandomTrim(),
                type: type
            };
        }

        // GENERIC VIN DECODER
        function decodeGenericVIN(vin) {
            const yearChar = vin.charAt(9);
            const year = getYearFromVIN(yearChar);
            
            const firstChar = vin.charAt(0);
            const regionMakes = {
                '1': 'FORD', '2': 'FORD', '3': 'FORD', '4': 'MAZDA', '5': 'HONDA',
                'J': 'TOYOTA', 'K': 'HYUNDAI', 'L': 'LINCOLN', 'S': 'SUBARU',
                'V': 'VOLVO', 'W': 'VOLKSWAGEN', 'Y': 'VOLVO', 'Z': 'MAZDA'
            };
            
            const make = regionMakes[firstChar] || 'UNKNOWN MAKE';
            let type = 'CAR';
            if (vin.includes('T') || vin.includes('U')) type = 'TRUCK';
            
            return {
                make: make,
                model: getModelFromMake(make, type),
                year: year,
                color: getRandomColor(),
                engine: '2.0L I4',
                trim: getRandomTrim(),
                type: type
            };
        }

        // HELPER FUNCTIONS
        function getYearFromVIN(yearChar) {
            const yearMap = {
                'A': 2010, 'B': 2011, 'C': 2012, 'D': 2013, 'E': 2014, 'F': 2015,
                'G': 2016, 'H': 2017, 'J': 2018, 'K': 2019, 'L': 2020, 'M': 2021,
                'N': 2022, 'P': 2023, 'R': 2024, 'S': 2025, 'T': 2026, 'V': 2027,
                'W': 2028, 'X': 2029, 'Y': 2030,
                '1': 2001, '2': 2002, '3': 2003, '4': 2004, '5': 2005, '6': 2006,
                '7': 2007, '8': 2008, '9': 2009
            };
            return yearMap[yearChar] || 2020;
        }

        function getModelFromMake(make, type) {
            const models = {
                'NISSAN': {
                    'CAR': ['ALTIMA', 'SENTRA', 'VERSA', 'MAXIMA', 'LEAF'],
                    'TRUCK': ['FRONTIER', 'TITAN'],
                    'SUV': ['ROGUE', 'MURANO', 'PATHFINDER', 'ARMADA', 'KICKS']
                },
                'FORD': {
                    'CAR': ['FOCUS', 'FUSION', 'TAURUS', 'MUSTANG'],
                    'TRUCK': ['F-150', 'RANGER', 'SUPER DUTY'],
                    'SUV': ['ESCAPE', 'EXPLORER', 'EXPEDITION', 'EDGE']
                },
                'CHEVROLET': {
                    'CAR': ['MALIBU', 'IMPALA', 'CAMARO', 'CORVETTE'],
                    'TRUCK': ['SILVERADO', 'COLORADO'],
                    'SUV': ['EQUINOX', 'TRAVERSE', 'TAHOE', 'SUBURBAN']
                },
                'TOYOTA': {
                    'CAR': ['CAMRY', 'COROLLA', 'AVALON', 'PRIUS'],
                    'TRUCK': ['TACOMA', 'TUNDRA'],
                    'SUV': ['RAV4', 'HIGHLANDER', '4RUNNER', 'SEQUOIA']
                },
                'HONDA': {
                    'CAR': ['CIVIC', 'ACCORD', 'INSIGHT'],
                    'SUV': ['CR-V', 'PILOT', 'HR-V', 'PASSPORT']
                }
            };
            
            const makeModels = models[make];
            if (makeModels && makeModels[type]) {
                const availableModels = makeModels[type];
                return availableModels[Math.floor(Math.random() * availableModels.length)];
            }
            
            const fallbacks = {
                'CAR': ['SEDAN', 'COUPE', 'HATCHBACK'],
                'TRUCK': ['PICKUP', 'TRUCK'],
                'SUV': ['SUV', 'CROSSOVER']
            };
            
            return fallbacks[type] ? fallbacks[type][0] : 'MODEL';
        }

        function getJapaneseEngine(make) {
            const engines = {
                'HONDA': ['1.5L I4', '2.0L I4', '2.4L I4'],
                'TOYOTA': ['2.5L I4', '3.5L V6', '2.0L I4 HYBRID'],
                'NISSAN': ['2.5L I4', '3.5L V6', '2.0L I4', '1.8L I4', '5.6L V8'],
                'LEXUS': ['2.5L I4', '3.5L V6', '5.0L V8']
            };
            return engines[make] ? engines[make][Math.floor(Math.random() * engines[make].length)] : '2.0L I4';
        }

        function getGermanEngine(make) {
            const engines = {
                'BMW': ['2.0L I4', '3.0L I6', '4.4L V8'],
                'MERCEDES-BENZ': ['2.0L I4', '3.0L V6', '4.0L V8'],
                'AUDI': ['2.0L I4', '3.0L V6'],
                'VOLKSWAGEN': ['1.8L I4', '2.0L I4']
            };
            return engines[make] ? engines[make][Math.floor(Math.random() * engines[make].length)] : '2.0L I4';
        }

        function getRandomColor() {
            const colors = ['Black', 'White', 'Silver', 'Gray', 'Red', 'Blue', 'Green', 'Brown'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function getRandomTrim() {
            const trims = ['Base', 'LX', 'EX', 'Touring', 'Sport', 'Limited', 'Platinum'];
            return trims[Math.floor(Math.random() * trims.length)];
        }

        // EXISTING FUNCTIONS
        function addCommonPart(partName) {
            const prices = {
                'engine': 500, 'transmission': 300, 'doors': 100, 'wheels': 50, 
                'battery': 80, 'alternator': 120, 'tailgate': 150, 'bedliner': 75,
                'seats': 200, 'rearhatch': 120, 'hood': 90
            };
            
            const newPart = {
                id: Date.now() + Math.random(),
                name: partName,
                price: prices[partName],
                condition: 'good',
                status: 'available'
            };
            
            currentParts.push(newPart);
            updatePartsPreview();
            generatePriceSuggestions();
        }

        function addCustomPart() {
            const name = document.getElementById('customPartName').value;
            const price = document.getElementById('customPartPrice').value;
            
            if (name && price) {
                const newPart = {
                    id: Date.now() + Math.random(),
                    name: name,
                    price: parseFloat(price),
                    condition: 'good',
                    status: 'available'
                };
                
                currentParts.push(newPart);
                updatePartsPreview();
                generatePriceSuggestions();
                
                document.getElementById('customPartName').value = '';
                document.getElementById('customPartPrice').value = '';
            } else {
                alert('Please enter both part name and price!');
            }
        }

        function updatePartsPreview() {
            const preview = document.getElementById('partsPreview');
            
            if (currentParts.length === 0) {
                preview.innerHTML = '<small class="text-muted">No parts added yet.</small>';
                return;
            }
            
            preview.innerHTML = currentParts.map(part => `
                <span class="badge bg-secondary me-2 mb-2 p-2">
                    ${part.name} - $${part.price}
                    <button class="btn-close btn-close-white ms-1" style="font-size: 0.7rem;" 
                            onclick="removePart(${part.id})"></button>
                </span>
            `).join('');
        }

        function removePart(partId) {
            currentParts = currentParts.filter(part => part.id !== partId);
            updatePartsPreview();
            generatePriceSuggestions();
        }

        function generatePriceSuggestions() {
            const totalPartsValue = currentParts.reduce((sum, part) => sum + part.price, 0);
            const suggestedVehiclePrice = totalPartsValue * 1.5; // 50% markup
            
            document.getElementById('priceSuggestions').innerHTML = 
                `Total parts value: $${totalPartsValue} | Suggested vehicle price: $${suggestedVehiclePrice.toFixed(2)}`;
            
            // Auto-fill price field if empty
            if (!document.getElementById('price').value && suggestedVehiclePrice > 0) {
                document.getElementById('price').value = suggestedVehiclePrice.toFixed(2);
            }
        }

        function clearVINData() {
            document.getElementById('vinInput').value = '';
            document.getElementById('make').value = '';
            document.getElementById('model').value = '';
            document.getElementById('year').value = '';
            document.getElementById('color').value = '';
            document.getElementById('engine').value = '';
            document.getElementById('trim').value = '';
            currentParts = [];
            updatePartsPreview();
        }

        function readFileAsDataURL(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.readAsDataURL(file);
            });
        }

        function updateInventoryList() {
            const inventoryList = document.getElementById('inventoryList');
            const searchTerm = document.getElementById('searchInventory').value.toLowerCase();
            const filterMake = document.getElementById('filterMake').value;
            const filterYear = document.getElementById('filterYear').value;
            
            let filteredInventory = inventory.filter(vehicle => {
                const matchesSearch = 
                    vehicle.make.toLowerCase().includes(searchTerm) ||
                    vehicle.model.toLowerCase().includes(searchTerm) ||
                    vehicle.vin.toLowerCase().includes(searchTerm);
                
                const matchesMake = !filterMake || vehicle.make === filterMake;
                const matchesYear = !filterYear || vehicle.year.toString() === filterYear;
                
                return matchesSearch && matchesMake && matchesYear;
            });
            
            if (filteredInventory.length === 0) {
                inventoryList.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-warning text-center">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            No vehicles match your search criteria.
                        </div>
                    </div>
                `;
                return;
            }
            
            inventoryList.innerHTML = filteredInventory.map(vehicle => `
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card vehicle-card h-100">
                        ${vehicle.photo ? 
                            `<img src="${vehicle.photo}" class="card-img-top" alt="${vehicle.make} ${vehicle.model}" style="height: 200px; object-fit: cover;">` : 
                            `<div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
                                <i class="fas fa-car fa-3x text-muted"></i>
                            </div>`
                        }
                        <div class="card-body">
                            <h5 class="card-title">${vehicle.year} ${vehicle.make} ${vehicle.model}</h5>
                            <p class="card-text">
                                <small class="text-muted">VIN: ${vehicle.vin}</small><br>
                                <strong>$${vehicle.price}</strong><br>
                                ${vehicle.color} • ${vehicle.engine} • ${vehicle.trim}<br>
                                <span class="badge bg-info">${vehicle.parts.length} parts</span>
                                ${vehicle.attachments && vehicle.attachments.length > 0 ? 
                                    `<span class="badge bg-secondary">${vehicle.attachments.length} files</span>` : ''}
                            </p>
                            <div class="mt-2">
                                ${vehicle.parts.slice(0, 3).map(part => 
                                    `<span class="badge bg-light text-dark part-badge me-1 mb-1">${part.name}</span>`
                                ).join('')}
                                ${vehicle.parts.length > 3 ? 
                                    `<span class="badge bg-light text-dark part-badge">+${vehicle.parts.length - 3} more</span>` : ''}
                            </div>
                        </div>
                        <div class="card-footer">
                            <small class="text-muted">Added: ${vehicle.dateAdded} | Location: ${vehicle.location}</small>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateDashboard() {
            document.getElementById('totalVehicles').textContent = inventory.length;
            
            const totalValue = inventory.reduce((sum, vehicle) => sum + vehicle.price, 0);
            document.getElementById('totalValue').textContent = '$' + totalValue.toLocaleString();
            
            const totalParts = inventory.reduce((sum, vehicle) => sum + vehicle.parts.length, 0);
            document.getElementById('totalParts').textContent = totalParts;
            
            document.getElementById('recentSales').textContent = salesHistory.length;
        }

        function updateFilters() {
            const makes = [...new Set(inventory.map(vehicle => vehicle.make))].sort();
            const years = [...new Set(inventory.map(vehicle => vehicle.year))].sort((a, b) => b - a);
            
            const makeFilter = document.getElementById('filterMake');
            const yearFilter = document.getElementById('filterYear');
            
            makeFilter.innerHTML = '<option value="">All Makes</option>' +
                makes.map(make => `<option value="${make}">${make}</option>`).join('');
                
            yearFilter.innerHTML = '<option value="">All Years</option>' +
                years.map(year => `<option value="${year}">${year}</option>`).join('');
        }

        function clearFilters() {
            document.getElementById('searchInventory').value = '';
            document.getElementById('filterMake').value = '';
            document.getElementById('filterYear').value = '';
            updateInventoryList();
        }

        function saveInventory() {
            localStorage.setItem('junkyardInventory', JSON.stringify(inventory));
        }

        function loadInventory() {
            const saved = localStorage.getItem('junkyardInventory');
            if (saved) {
                inventory = JSON.parse(saved);
                updateInventoryList();
                updateDashboard();
                updateFilters();
            }
        }

        function loadSales() {
            // Sales history loading logic
            console.log('Sales history loaded:', salesHistory.length, 'records');
        }

        // ENHANCED: Initialize app with parts database
        function initializeApp() {
            initializePartsDatabase();
            // Your existing initialization code...
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadInventory();
            loadSales();
            initializeApp();
            
            // Set up search and filter events
            document.getElementById('searchInventory').addEventListener('input', updateInventoryList);
            document.getElementById('filterMake').addEventListener('change', updateInventoryList);
            document.getElementById('filterYear').addEventListener('change', updateInventoryList);
            
            console.log('Premier Auto Truck & Salvage Inventory with AI VIN Scanner loaded!');
        });
    </script>
</body>
</html>
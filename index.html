<script>
// Enhanced inventory system with all new features
let inventory = [];
let currentParts = [];
let currentAttachments = []; // NEW: File attachments
let salesHistory = JSON.parse(localStorage.getItem('junkyardSales')) || [];
let cameraStream = null;
let scannedVIN = '';
let barcodeDetector = null;
let partsDatabase = JSON.parse(localStorage.getItem('partsDatabase')) || {}; // NEW: Parts database

// Initialize AI Barcode Detector if available
if ('BarcodeDetector' in window) {
    barcodeDetector = new BarcodeDetector({
        formats: ['code_39', 'code_128', 'codabar', 'ean_13', 'ean_8', 'upc_a', 'upc_e']
    });
}

// NEW: Initialize parts database on app start
function initializePartsDatabase() {
    if (Object.keys(partsDatabase).length === 0) {
        partsDatabase = {
            'ENGINE': {
                category: 'Powertrain',
                commonPrice: 500,
                compatibleMakes: ['ALL'],
                description: 'Complete engine assembly',
                files: []
            },
            'TRANSMISSION': {
                category: 'Powertrain', 
                commonPrice: 300,
                compatibleMakes: ['ALL'],
                description: 'Manual or automatic transmission',
                files: []
            },
            'BATTERY': {
                category: 'Electrical',
                commonPrice: 80,
                compatibleMakes: ['ALL'],
                description: '12V automotive battery',
                files: []
            },
            'ALTERNATOR': {
                category: 'Electrical',
                commonPrice: 120,
                compatibleMakes: ['ALL'],
                description: 'Charging system alternator',
                files: []
            },
            'WHEELS': {
                category: 'Suspension',
                commonPrice: 50,
                compatibleMakes: ['ALL'],
                description: 'Set of 4 wheels',
                files: []
            },
            'DOORS': {
                category: 'Body',
                commonPrice: 100,
                compatibleMakes: ['ALL'],
                description: 'Complete door assembly',
                files: []
            }
        };
        savePartsDatabase();
    }
}

function savePartsDatabase() {
    localStorage.setItem('partsDatabase', JSON.stringify(partsDatabase));
}

// ENHANCED: Full Screen Scanner Functions with Professional UI
function openFullScreenScanner() {
    const scanner = document.getElementById('fullScreenScanner');
    scanner.style.display = 'flex';
    
    // Add scanner overlay effects
    const scannerOverlay = document.getElementById('scannerOverlay');
    if (scannerOverlay) {
        scannerOverlay.innerHTML = `
            <div class="scanner-frame">
                <div class="scanner-corner top-left"></div>
                <div class="scanner-corner top-right"></div>
                <div class="scanner-corner bottom-left"></div>
                <div class="scanner-corner bottom-right"></div>
                <div class="scanning-line"></div>
            </div>
            <div class="scanner-instruction">Align VIN barcode within the frame</div>
        `;
    }
    
    // Access camera with better settings
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        const constraints = {
            video: { 
                facingMode: 'environment',
                width: { ideal: 1920 },
                height: { ideal: 1080 },
                focusMode: 'continuous'
            },
            audio: false
        };
        
        navigator.mediaDevices.getUserMedia(constraints)
        .then(function(stream) {
            cameraStream = stream;
            const video = document.getElementById('scannerVideo');
            video.srcObject = stream;
            
            video.onloadedmetadata = function() {
                video.play();
                // Start enhanced AI detection
                startEnhancedBarcodeDetection(video);
            };
        })
        .catch(function(err) {
            console.error('Camera error:', err);
            showScannerError('Camera access denied: ' + err.message);
        });
    } else {
        showScannerError('Camera not supported on this device');
    }
}

// ENHANCED: AI Barcode Detection with better feedback
function startEnhancedBarcodeDetection(video) {
    if (!barcodeDetector) {
        startFallbackDetection(video);
        return;
    }
    
    const canvas = document.createElement('canvas');
    const context = canvas.getContext('2d');
    let detectionCount = 0;
    
    function detectBarcode() {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            barcodeDetector.detect(canvas)
                .then(barcodes => {
                    detectionCount++;
                    updateDetectionStatus(detectionCount);
                    
                    if (barcodes.length > 0) {
                        const barcode = barcodes[0];
                        const rawValue = barcode.rawValue.toUpperCase().trim();
                        
                        // Enhanced VIN validation
                        if (isValidVIN(rawValue)) {
                            handleSuccessfulScan(rawValue, barcode);
                        } else {
                            showScanFeedback('Invalid VIN format detected', 'warning');
                        }
                    }
                })
                .catch(err => {
                    console.log('Barcode detection error:', err);
                });
        }
        requestAnimationFrame(detectBarcode);
    }
    
    detectBarcode();
}

// NEW: Enhanced VIN validation
function isValidVIN(vin) {
    return vin.length === 17 && !/[IOQ]/.test(vin) && /^[A-HJ-NPR-Z0-9]{17}$/.test(vin);
}

// NEW: Handle successful scan
function handleSuccessfulScan(vin, barcode) {
    scannedVIN = vin;
    const scannedVINElement = document.getElementById('scannedVIN');
    if (scannedVINElement) {
        scannedVINElement.innerHTML = `
            <i class="fas fa-check-circle"></i>
            <strong>VIN Detected:</strong> ${vin}
            <br><small>Bounding Box: ${JSON.stringify(barcode.boundingBox)}</small>
        `;
        scannedVINElement.className = 'scan-result success';
    }
    
    // Auto-capture after successful scan
    setTimeout(() => {
        captureVINFromScanner();
    }, 1000);
}

// NEW: Update detection status
function updateDetectionStatus(count) {
    const statusEl = document.getElementById('detectionStatus');
    if (statusEl) {
        statusEl.textContent = `AI Scanning... (${count} frames analyzed)`;
    }
}

// NEW: Show scan feedback
function showScanFeedback(message, type) {
    const feedbackEl = document.getElementById('scanFeedback');
    if (feedbackEl) {
        feedbackEl.textContent = message;
        feedbackEl.className = `scan-feedback ${type}`;
        setTimeout(() => {
            feedbackEl.textContent = '';
            feedbackEl.className = 'scan-feedback';
        }, 3000);
    }
}

// NEW: Show scanner error
function showScannerError(message) {
    alert('Cannot access camera: ' + message);
    closeFullScreenScanner();
}

// Fallback detection (your existing simulateBarcodeScanning)
function startFallbackDetection(video) {
    setTimeout(() => {
        const demoVINs = [
            '1N4AL3AP3DN534388', // Your test VIN
            '1HGBH41JXMN109186',
            '2FMDK3GC5DBA12345', 
            '1G1JC5240X7252365',
            '5YJSA1CN5DFP12345'
        ];
        
        const randomVIN = demoVINs[Math.floor(Math.random() * demoVINs.length)];
        scannedVIN = randomVIN;
        
        const scannedVINElement = document.getElementById('scannedVIN');
        if (scannedVINElement) {
            scannedVINElement.textContent = `Scanned VIN: ${randomVIN}`;
            scannedVINElement.style.background = '#d4edda';
            scannedVINElement.style.borderLeftColor = '#28a745';
        }
    }, 3000);
}

function closeFullScreenScanner() {
    const scanner = document.getElementById('fullScreenScanner');
    if (scanner) {
        scanner.style.display = 'none';
    }
    
    if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
    }
    
    // Clear any scanned VIN
    scannedVIN = '';
    const scannedVINElement = document.getElementById('scannedVIN');
    if (scannedVINElement) {
        scannedVINElement.textContent = 'Point camera at VIN barcode...';
        scannedVINElement.style.background = '#f8f9fa';
        scannedVINElement.style.borderLeftColor = '#28a745';
    }
}

function captureVINFromScanner() {
    if (scannedVIN) {
        document.getElementById('vinInput').value = scannedVIN;
        closeFullScreenScanner();
        lookupVIN();
    } else {
        alert('No VIN detected yet. Please point camera at VIN barcode.');
    }
}

// NEW: Parts Database Integration
function pullPartsFromDatabase(vehicleMake, vehicleModel, vehicleYear) {
    const compatibleParts = [];
    
    Object.keys(partsDatabase).forEach(partName => {
        const part = partsDatabase[partName];
        if (part.compatibleMakes.includes('ALL') || 
            part.compatibleMakes.includes(vehicleMake.toUpperCase())) {
            
            compatibleParts.push({
                name: partName,
                price: part.commonPrice,
                category: part.category,
                description: part.description,
                source: 'database'
            });
        }
    });
    
    return compatibleParts;
}

// ENHANCED: Auto-generate parts with database integration
function autoGenerateParts(vehicleType, vehicleMake = '', vehicleModel = '') {
    currentParts = [];
    
    // Pull from database first
    if (vehicleMake) {
        const dbParts = pullPartsFromDatabase(vehicleMake, vehicleModel, '');
        dbParts.forEach(part => {
            currentParts.push({
                id: Date.now() + Math.random(),
                name: part.name,
                price: part.price,
                condition: 'good',
                status: 'available',
                category: part.category,
                description: part.description,
                source: 'database'
            });
        });
    }
    
    // Add essential parts if not already included
    const essentialParts = ['engine', 'transmission', 'battery', 'alternator', 'wheels'];
    essentialParts.forEach(partName => {
        if (!currentParts.some(part => part.name.toLowerCase() === partName.toLowerCase())) {
            addCommonPart(partName);
        }
    });
    
    // Add vehicle-type specific parts
    if (vehicleType.includes('TRUCK') || vehicleType.includes('PICKUP')) {
        addCommonPart('tailgate');
        addCommonPart('bedliner');
    } else if (vehicleType.includes('SUV') || vehicleType.includes('VAN')) {
        addCommonPart('seats');
        addCommonPart('rearhatch');
    } else {
        addCommonPart('doors');
        addCommonPart('hood');
    }
    
    updatePartsPreview();
    generatePriceSuggestions();
}

// NEW: File attachment system
function handleFileAttachments(files) {
    Array.from(files).forEach(file => {
        if (file.size > 10 * 1024 * 1024) { // 10MB limit
            alert('File too large: ' + file.name);
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const attachment = {
                id: Date.now() + Math.random(),
                name: file.name,
                type: file.type,
                size: file.size,
                data: e.target.result,
                uploadDate: new Date().toISOString()
            };
            
            currentAttachments.push(attachment);
            updateAttachmentsPreview();
        };
        reader.readAsDataURL(file);
    });
}

function updateAttachmentsPreview() {
    const preview = document.getElementById('attachmentsPreview');
    if (!preview) return;
    
    if (currentAttachments.length === 0) {
        preview.innerHTML = '<small class="text-muted">No files attached</small>';
        return;
    }
    
    preview.innerHTML = currentAttachments.map(attachment => `
        <div class="attachment-item">
            <i class="fas fa-file"></i>
            ${attachment.name} (${formatFileSize(attachment.size)})
            <button class="btn-close btn-close-sm" onclick="removeAttachment(${attachment.id})"></button>
        </div>
    `).join('');
}

function removeAttachment(attachmentId) {
    currentAttachments = currentAttachments.filter(att => att.id !== attachmentId);
    updateAttachmentsPreview();
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// ENHANCED: Add vehicle with attachments
function addVehicle() {
    const make = document.getElementById('make').value;
    const model = document.getElementById('model').value;
    const year = document.getElementById('year').value;
    const price = document.getElementById('price').value;
    const location = document.getElementById('location').value;
    const vin = document.getElementById('vinInput').value;
    const color = document.getElementById('color').value;
    const engine = document.getElementById('engine').value;
    const trim = document.getElementById('trim').value;
    const photoFile = document.getElementById('photoUpload').files[0];

    if (!vin) {
        alert('Please enter a VIN number!');
        return;
    }

    if (make && model && year && price) {
        const photoPromise = photoFile ? readFileAsDataURL(photoFile) : Promise.resolve(null);
        
        photoPromise.then(photoData => {
            const newVehicle = {
                id: Date.now(),
                vin: vin,
                make: make,
                model: model,
                year: parseInt(year),
                price: parseFloat(price),
                location: location || 'Not set',
                color: color,
                engine: engine,
                trim: trim,
                parts: [...currentParts],
                attachments: [...currentAttachments], // NEW: Include attachments
                photo: photoData,
                dateAdded: new Date().toLocaleDateString()
            };

            inventory.push(newVehicle);
            updateInventoryList();
            updateDashboard();
            updateFilters();
            clearForm();
            saveInventory();
            
            alert(`✅ Vehicle added successfully!\nVIN: ${vin}\nParts: ${currentParts.length}\nFiles: ${currentAttachments.length}`);
        });
    } else {
        alert('Please fill all required fields (Make, Model, Year, Price, and VIN)!');
    }
}

// ENHANCED: Clear form with attachments
function clearForm() {
    document.getElementById('make').value = '';
    document.getElementById('model').value = '';
    document.getElementById('year').value = '';
    document.getElementById('price').value = '';
    document.getElementById('location').value = '';
    document.getElementById('photoUpload').value = '';
    document.getElementById('customPartName').value = '';
    document.getElementById('customPartPrice').value = '';
    document.getElementById('vinInput').value = '';
    document.getElementById('color').value = '';
    document.getElementById('engine').value = '';
    document.getElementById('trim').value = '';
    
    // NEW: Clear attachments
    const fileInput = document.getElementById('fileAttachments');
    if (fileInput) fileInput.value = '';
    currentAttachments = [];
    updateAttachmentsPreview();
    
    currentParts = [];
    updatePartsPreview();
    generatePriceSuggestions();
}

// ENHANCED: Initialize app with parts database
function initializeApp() {
    initializePartsDatabase();
    // Your existing initialization code...
}

// KEEP ALL YOUR EXISTING FUNCTIONS BELOW:
// decodeVIN, decodeNissanVIN, decodeUSVIN, decodeJapaneseVIN, 
// decodeGermanVIN, decodeKoreanVIN, decodeGenericVIN,
// getYearFromVIN, getModelFromMake, getJapaneseEngine, getGermanEngine,
// getRandomColor, getRandomTrim, addCommonPart, addCustomPart,
// updatePartsPreview, removePart, generatePriceSuggestions,
// clearVINData, readFileAsDataURL, updateInventoryList,
// updateDashboard, updateFilters, saveInventory, loadInventory,
// loadSales, and all other existing functions...

// Initialize app
document.addEventListener('DOMContentLoaded', function() {
    loadInventory();
    loadSales();
    initializeApp();
    console.log('Premier Auto Truck & Salvage Inventory with AI VIN Scanner loaded!');
});
</script>